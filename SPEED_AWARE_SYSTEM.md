# Speed-Aware Tick Synchronization System

## üéØ –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∏ –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø–∞—É–∑—ã –¥–ª—è CS2 Demo Input Visualizer.

### –ö–ª—é—á–µ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

‚úÖ **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã—á–∏—Å–ª—è–µ—Ç —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å (0.25x, 0.5x, 1.0x, 2.0x, etc.)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Ç–∏–∫–æ–≤ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
- –ü–ª–∞–≤–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–∫–æ—Ä–æ—Å—Ç–∏

‚úÖ **–¢–æ—á–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –ø–∞—É–∑—ã**
- –û—Ç–ª–∏—á–∞–µ—Ç –ø–∞—É–∑—É –æ—Ç –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ (0.05x)
- –ù–µ –ø—É—Ç–∞–µ—Ç –ø–∞—É–∑—É —Å "–¥–µ–º–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ" (tick=0)
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –∑–∞ ~0.6 —Å–µ–∫—É–Ω–¥—ã (3 –∏–∑–º–µ—Ä–µ–Ω–∏—è)

‚úÖ **Speed-aware –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ç–∏–∫–æ–≤**
- –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Å —É—á–µ—Ç–æ–º —Ç–µ–∫—É—â–µ–π —Å–∫–æ—Ä–æ—Å—Ç–∏
- –í–æ –≤—Ä–µ–º—è –ø–∞—É–∑—ã –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è
- Smooth 60 FPS —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –ø—Ä–∏ –ª—é–±–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏

‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–µ—Ç demo_marktick**
- –ü–∞—Å—Å–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ (–Ω–µ –ø–∞—É–∑–∏—Ç –¥–µ–º–æ)
- –ù–µ—Ç "–¥–µ—Ä–≥–∞–Ω–æ–π" –∫–∞—Ä—Ç–∏–Ω–∫–∏
- –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç FILE tick (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å demoparser2)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
SmartTickSync (src/core/smart_tick_sync.py)
‚îú‚îÄ‚îÄ Tick Synchronization (demo_marktick polling)
‚îú‚îÄ‚îÄ Speed Calculation (from tick history)
‚îú‚îÄ‚îÄ Pause Detection (identical ticks check)
‚îî‚îÄ‚îÄ Speed-Aware Prediction (interpolation)

CS2TelnetClient (src/network/telnet_client.py)
‚îú‚îÄ‚îÄ get_current_tick() ‚Üí demo_marktick
‚îî‚îÄ‚îÄ get_tick_via_marktick() ‚Üí "Marked tick XXXXX"

Orchestrator (src/core/orchestrator.py)
‚îú‚îÄ‚îÄ _sync_loop() ‚Üí polls SmartTickSync every 0.25s
‚îî‚îÄ‚îÄ _render_loop() ‚Üí uses predict_current_tick() at 60 FPS
```

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö

```
CS2 Demo Playback (any speed)
        ‚Üì
demo_marktick command via telnet
        ‚Üì
CS2TelnetClient.get_tick_via_marktick()
        ‚Üì (every 0.25s)
SmartTickSync.update()
‚îú‚îÄ‚îÄ Add measurement to history
‚îú‚îÄ‚îÄ Calculate speed from tick differences
‚îú‚îÄ‚îÄ Detect pause (3 identical ticks > 0)
‚îî‚îÄ‚îÄ Store last known tick + speed
        ‚Üì
SmartTickSync.predict_current_tick()
‚îú‚îÄ‚îÄ If paused: return last tick
‚îú‚îÄ‚îÄ If playing: last_tick + (time_elapsed * tick_rate * speed)
‚îî‚îÄ‚îÄ Return predicted tick
        ‚Üì (60 FPS)
Orchestrator._render_loop()
‚îú‚îÄ‚îÄ Get predicted tick
‚îú‚îÄ‚îÄ Fetch InputData from cache
‚îî‚îÄ‚îÄ Render overlay
```

---

## üìä –ê–ª–≥–æ—Ä–∏—Ç–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–∫–æ—Ä–æ—Å—Ç–∏

### –ú–µ—Ç–æ–¥: Linear Speed Calculation

```python
# –î–∞–Ω–æ: –∏—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏–π (tick, timestamp)
history = [
    (time=0.00, tick=1000),
    (time=0.50, tick=1016),  # +16 —Ç–∏–∫–æ–≤ –∑–∞ 0.5 —Å–µ–∫
]

# –í—ã—á–∏—Å–ª–µ–Ω–∏–µ:
tick_diff = 1016 - 1000 = 16
time_diff = 0.50 - 0.00 = 0.5

# –ò–∑–º–µ—Ä–µ–Ω–Ω—ã–π tickrate
measured_tick_rate = tick_diff / time_diff = 16 / 0.5 = 32 tps

# –°–∫–æ—Ä–æ—Å—Ç—å
speed = measured_tick_rate / base_tick_rate = 32 / 64 = 0.5x
```

### –°–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ (Exponential Moving Average)

```python
# –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Å–∫–∞—á–∫–æ–≤ –ø—Ä–∏ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–ª–µ–±–∞–Ω–∏—è—Ö
alpha = 0.3  # –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
smoothed_speed = alpha * new_speed + (1 - alpha) * previous_speed
```

### –û–∫–Ω–æ —Ä–∞—Å—á–µ—Ç–∞

- **–ò—Å—Ç–æ—Ä–∏—è**: 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π
- **–û–∫–Ω–æ —Ä–∞—Å—á–µ—Ç–∞**: 5 –∏–∑–º–µ—Ä–µ–Ω–∏–π (—Å—Ç–∞—Ä–µ–π—à–µ–µ –∏ –Ω–æ–≤–µ–π—à–µ–µ)
- **–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–ø—Ä–æ—Å–∞**: 0.5 —Å–µ–∫—É–Ω–¥—ã (–æ–ø—Ç–∏–º–∞–ª—å–Ω–æ)
- **–í—Ä–µ–º—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏**: ~2.5 —Å–µ–∫—É–Ω–¥—ã (5 –∏–∑–º–µ—Ä–µ–Ω–∏–π √ó 0.5s)

### Edge Cases Handling

**1. Tick Jumps (Shift+F2 goto)**

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –ø—Ä—ã–∂–æ–∫ –Ω–∞ –¥—Ä—É–≥–æ–π —Ç–∏–∫ (Shift+F2), —Ä–∞–∑–Ω–∏—Ü–∞ —Ç–∏–∫–æ–≤ –±—É–¥–µ—Ç –æ–≥—Ä–æ–º–Ω–æ–π:

```python
# –î–µ—Ç–µ–∫—Ü–∏—è —Å–∫–∞—á–∫–∞ —Ç–∏–∫–æ–≤:
expected_diff = tick_rate * time_diff * current_speed
if abs(tick_diff) > abs(expected_diff) * 5:
    # –≠—Ç–æ —Å–∫–∞—á–æ–∫, –Ω–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏
    discard_measurement()
```

**–ü—Ä–∏–º–µ—Ä:**
```
Current speed: 1.0x
Time elapsed: 0.5s
Expected tick_diff: 64 * 0.5 * 1.0 = 32 —Ç–∏–∫–∞

Actual tick_diff: 5000 —Ç–∏–∫–æ–≤ (jump!)
5000 > 32 * 5 = 160 ‚Üí –°–∫–∞—á–æ–∫ –¥–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω ‚úÖ
```

**2. Outlier Detection**

–ò–∑–º–µ—Ä–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ —Å–∏–ª—å–Ω–æ –æ—Ç–ª–∏—á–∞—é—Ç—Å—è –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —Å—Ä–µ–¥–Ω–µ–≥–æ, –æ—Ç–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è:

```python
def is_outlier(speed, threshold=0.5):
    deviation = abs(speed - current_average)
    return deviation > threshold
```

**–ü—Ä–∏–º–µ—Ä:**
```
Current average: 1.0x
New measurement: 3.5x
Deviation: |3.5 - 1.0| = 2.5x > 0.5x ‚Üí Outlier ‚úÖ

Current average: 1.0x
New measurement: 1.3x
Deviation: |1.3 - 1.0| = 0.3x < 0.5x ‚Üí Valid ‚úÖ
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ:**
- –°–µ—Ç–µ–≤—ã–µ –≥–ª—é–∫–∏ –º–æ–≥—É—Ç –¥–∞–≤–∞—Ç—å –Ω–µ–≤–µ—Ä–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è
- –í—Ä–µ–º–µ–Ω–Ω—ã–µ –ª–∞–≥–∏ –º–æ–≥—É—Ç –∏—Å–∫–∞–∂–∞—Ç—å time_diff
- –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–∫–æ—Ä–æ—Å—Ç–∏

---

## üõë –ê–ª–≥–æ—Ä–∏—Ç–º –¥–µ—Ç–µ–∫—Ü–∏–∏ –ø–∞—É–∑—ã

### –õ–æ–≥–∏–∫–∞

```python
def is_paused():
    # –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º N –∏–∑–º–µ—Ä–µ–Ω–∏–π
    if len(history) < pause_threshold:  # pause_threshold = 3
        return False

    # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —Ç–∏–∫–æ–≤
    recent_ticks = [1000, 1000, 1000]

    # –í—Å–µ —Ç–∏–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ?
    all_same = len(set(recent_ticks)) == 1  # True

    # –¢–∏–∫ –±–æ–ª—å—à–µ 0? (–µ—Å–ª–∏ 0 = –¥–µ–º–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ)
    tick_value = recent_ticks[0]  # 1000

    # –í—Ä–µ–º—è –ø—Ä–æ—à–ª–æ –º–µ–∂–¥—É –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏?
    time_diff = 0.6  # —Å–µ–∫—É–Ω–¥

    # –ü–∞—É–∑–∞ –¥–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç—Å—è –µ—Å–ª–∏:
    # - –í—Å–µ —Ç–∏–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ
    # - –¢–∏–∫ > 0
    # - –í—Ä–µ–º—è –ø—Ä–æ—à–ª–æ (> 0.1s)
    return all_same and tick_value > 0 and time_diff > 0.1
```

### –ü—Ä–∏–º–µ—Ä—ã

| –°–∏—Ç—É–∞—Ü–∏—è | –¢–∏–∫–∏ | –†–µ–∑—É–ª—å—Ç–∞—Ç | –ü—Ä–∏—á–∏–Ω–∞ |
|----------|------|-----------|---------|
| –ü–∞—É–∑–∞ | [5000, 5000, 5000] | ‚úÖ –ü–∞—É–∑–∞ | –í—Å–µ –æ–¥–∏–Ω–∞–∫–æ–≤—ã–µ, > 0 |
| –î–µ–º–æ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ | [0, 0, 0] | ‚ùå –ù–µ –ø–∞—É–∑–∞ | Tick = 0 |
| –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å | [5000, 5001, 5002] | ‚ùå –ù–µ –ø–∞—É–∑–∞ | –¢–∏–∫–∏ –º–µ–Ω—è—é—Ç—Å—è |
| –ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å | [1000, 1016, 1032] | ‚ùå –ù–µ –ø–∞—É–∑–∞ | –¢–∏–∫–∏ –º–µ–Ω—è—é—Ç—Å—è |

---

## üéÆ Speed-Aware Prediction

### –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è —Å —É—á–µ—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏

```python
def predict_current_tick():
    # –ï—Å–ª–∏ –ø–∞—É–∑–∞ - –±–µ–∑ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è
    if is_paused:
        return last_tick

    # –í—Ä–µ–º—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ—Ä–µ–Ω–∏—è
    time_elapsed = now() - last_update_time  # 0.016s (1 –∫–∞–¥—Ä –ø—Ä–∏ 60 FPS)

    # –¢–∏–∫–∏ –∑–∞ —ç—Ç–æ –≤—Ä–µ–º—è —Å —É—á–µ—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
    ticks_per_second = tick_rate * current_speed  # 64 * 0.5 = 32 tps
    ticks_elapsed = time_elapsed * ticks_per_second  # 0.016 * 32 = 0.512 —Ç–∏–∫–∞

    # –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∏–∫
    predicted = last_tick + int(ticks_elapsed)

    return predicted
```

### –ü—Ä–∏–º–µ—Ä—ã –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏—è

**–°–∫–æ—Ä–æ—Å—Ç—å 1.0x (–Ω–æ—Ä–º–∞–ª—å–Ω–∞—è):**
```
Last sync: tick=1000 at t=0.000s
Current:   t=0.500s
Prediction: 1000 + (0.5 * 64 * 1.0) = 1032
```

**–°–∫–æ—Ä–æ—Å—Ç—å 0.25x (–º–µ–¥–ª–µ–Ω–Ω–∞—è):**
```
Last sync: tick=1000 at t=0.000s
Current:   t=0.500s
Prediction: 1000 + (0.5 * 64 * 0.25) = 1008
```

**–°–∫–æ—Ä–æ—Å—Ç—å 2.0x (–±—ã—Å—Ç—Ä–∞—è):**
```
Last sync: tick=1000 at t=0.000s
Current:   t=0.500s
Prediction: 1000 + (0.5 * 64 * 2.0) = 1064
```

**–í–æ –≤—Ä–µ–º—è –ø–∞—É–∑—ã:**
```
Last sync: tick=1000 at t=0.000s
Current:   t=5.000s (but paused)
Prediction: 1000 (no interpolation)
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã SmartTickSync

```python
smart_sync = SmartTickSync(
    tick_source=telnet_client,
    tick_rate=64,              # –ë–∞–∑–æ–≤—ã–π tickrate —Å–µ—Ä–≤–µ—Ä–∞
    history_size=10,           # –†–∞–∑–º–µ—Ä –∏—Å—Ç–æ—Ä–∏–∏ –∏–∑–º–µ—Ä–µ–Ω–∏–π
    pause_threshold=3,         # –°–∫–æ–ª—å–∫–æ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ç–∏–∫–æ–≤ = –ø–∞—É–∑–∞
    speed_calculation_window=5 # –û–∫–Ω–æ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏
)
```

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ |
|----------|----------|-------------|
| `tick_rate` | 64 | –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π tickrate CS2 matchmaking |
| `history_size` | 10 | –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏, –Ω–µ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–∞–º—è—Ç–∏ |
| `pause_threshold` | 3 | –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É —Å–∫–æ—Ä–æ—Å—Ç—å—é –¥–µ—Ç–µ–∫—Ü–∏–∏ –∏ –ª–æ–∂–Ω—ã–º–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è–º–∏ |
| `speed_calculation_window` | 5 | –°—Ç–∞–±–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π –∏–Ω–µ—Ä—Ü–∏–∏ |
| `polling_interval` | **0.5s** | **–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (research)**: –º–µ–Ω—å—à–µ jitter, —Å—Ç–∞–±–∏–ª—å–Ω–µ–µ (–±—ã–ª–æ 0.25s) |

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤—ã–π –ø—Ä–∏–º–µ—Ä

```python
from src.network.telnet_client import CS2TelnetClient
from src.core.smart_tick_sync import SmartTickSync

# –°–æ–∑–¥–∞—Ç—å telnet –∫–ª–∏–µ–Ω—Ç
telnet = CS2TelnetClient(host="127.0.0.1", port=2121)
await telnet.connect()

# –°–æ–∑–¥–∞—Ç—å SmartTickSync
smart_sync = SmartTickSync(
    tick_source=telnet,
    tick_rate=64
)

# –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å (–≤ sync loop)
while True:
    await smart_sync.update()  # Polls demo_marktick
    await asyncio.sleep(0.5)  # Recommended: 0.5s for optimal balance

# –í render loop (60 FPS)
while True:
    # –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–Ω—ã–π —Ç–∏–∫
    current_tick = smart_sync.predict_current_tick()

    # –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–∫–æ—Ä–æ—Å—Ç—å
    speed = smart_sync.get_current_speed()

    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—É–∑—É
    if smart_sync.is_paused():
        # –ù–µ —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å overlay
        pass
    else:
        # –†–µ–Ω–¥–µ—Ä–∏—Ç—å —Å —É—á–µ—Ç–æ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
        render_overlay(current_tick, speed)

    await asyncio.sleep(1/60)
```

### Integration —Å Orchestrator

```python
# –í Orchestrator.initialize()
self.smart_tick_sync = SmartTickSync(
    self.tick_source,
    tick_rate=self.tick_rate,
    history_size=10,
    pause_threshold=3,
    speed_calculation_window=5
)

# Initial sync
await self.smart_tick_sync.update()

# –í _sync_loop()
while self._running:
    await self.smart_tick_sync.update()
    await asyncio.sleep(self.polling_interval)

# –í _render_loop()
while self._running:
    tick = self.smart_tick_sync.predict_current_tick()
    speed = self.smart_tick_sync.get_current_speed()
    paused = self.smart_tick_sync.is_paused()

    if not paused:
        input_data = self.demo_repo.get_inputs(tick, player)
        input_data.playback_speed = speed
        self.visualizer.render(input_data)

    await asyncio.sleep(1/60)
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

```bash
# –ü–æ–ª–Ω—ã–µ —Ç–µ—Å—Ç—ã SmartTickSync
python test_smart_tick_sync.py

# –¢–µ—Å—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –±–∞–∑–æ–≤–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
python test_fixes.py
```

### –¢–µ—Å—Ç-–∫–µ–π—Å—ã

1. **–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏**
   - Normal (1.0x)
   - Slow (0.25x)
   - Fast (2.0x)

2. **–î–µ—Ç–µ–∫—Ü–∏—è –ø–∞—É–∑—ã**
   - –ü–∞—É–∑–∞ (identical ticks > 0)
   - –ù–µ –ø–∞—É–∑–∞ –ø—Ä–∏ tick=0
   - –ù–µ –ø–∞—É–∑–∞ –ø—Ä–∏ –æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏

3. **Speed-aware prediction**
   - –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –ø—Ä–∏ —Ä–∞–∑–Ω—ã—Ö —Å–∫–æ—Ä–æ—Å—Ç—è—Ö
   - –ü—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ –≤–æ –≤—Ä–µ–º—è –ø–∞—É–∑—ã (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å = last_tick)

4. **Status info**
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –æ—Ç—á–µ—Ç–∞ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏

---

## üêõ Troubleshooting

### –ü—Ä–æ–±–ª–µ–º–∞: –°–∫–æ—Ä–æ—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–°–∏–º–ø—Ç–æ–º—ã**: `current_speed` –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ä–µ–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–µ–º–æ

**–ü—Ä–∏—á–∏–Ω—ã**:
1. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ (< 5)
2. –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –∏–∑–º–µ—Ä–µ–Ω–∏—è–º–∏
3. –¢–∏–∫–∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è (–ø–∞—É–∑–∞)

**–†–µ—à–µ–Ω–∏–µ**:
```python
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
status = smart_sync.get_status_info()
print(f"History size: {status['history_size']}")
print(f"History: {status['history']}")

# –£–≤–µ–ª–∏—á–∏—Ç—å –æ–∫–Ω–æ —Ä–∞—Å—á–µ—Ç–∞
smart_sync = SmartTickSync(
    ...,
    speed_calculation_window=7  # –£–≤–µ–ª–∏—á–∏—Ç—å —Å 5 –¥–æ 7
)
```

### –ü—Ä–æ–±–ª–µ–º–∞: –õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –ø–∞—É–∑—ã

**–°–∏–º–ø—Ç–æ–º—ã**: `is_paused()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `True` –∫–æ–≥–¥–∞ –¥–µ–º–æ –∏–≥—Ä–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã**:
1. –û—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å (<0.05x) + –∫–æ—Ä–æ—Ç–∫–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª
2. –°–µ—Ç–µ–≤—ã–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –≤ telnet
3. pause_threshold —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–π

**–†–µ—à–µ–Ω–∏–µ**:
```python
# –£–≤–µ–ª–∏—á–∏—Ç—å pause_threshold
smart_sync = SmartTickSync(
    ...,
    pause_threshold=5  # –£–≤–µ–ª–∏—á–∏—Ç—å —Å 3 –¥–æ 5
)

# –ò–ª–∏ —É–º–µ–Ω—å—à–∏—Ç—å polling_interval
orchestrator = Orchestrator(
    ...,
    polling_interval=0.1  # –£–º–µ–Ω—å—à–∏—Ç—å —Å 0.25 –¥–æ 0.1
)
```

### –ü—Ä–æ–±–ª–µ–º–∞: Overlay "–¥–µ—Ä–≥–∞–µ—Ç—Å—è" –ø—Ä–∏ —Å–º–µ–Ω–µ —Å–∫–æ—Ä–æ—Å—Ç–∏

**–°–∏–º–ø—Ç–æ–º—ã**: –†–µ–∑–∫–∏–µ —Å–∫–∞—á–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ demo_timescale

**–ü—Ä–∏—á–∏–Ω—ã**:
1. –°–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è (alpha=0.3 –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã—Å–æ–∫–∏–º)
2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ**:
```python
# –í SmartTickSync._recalculate_speed()
# –£–º–µ–Ω—å—à–∏—Ç—å alpha –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ —Å–≥–ª–∞–∂–∏–≤–∞–Ω–∏—è
alpha = 0.2  # –ë—ã–ª–æ 0.3

# –ò–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å speed_calculation_window
smart_sync = SmartTickSync(
    ...,
    speed_calculation_window=7  # –ë–æ–ª—å—à–µ –æ–∫–Ω–æ = –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ
)
```

---

## üìà Performance

### –ú–µ—Ç—Ä–∏–∫–∏

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|----------|----------|------------|
| CPU (sync loop) | <1% | –û–¥–Ω–∞ telnet –∫–æ–º–∞–Ω–¥–∞ –∫–∞–∂–¥—ã–µ 0.5s |
| CPU (prediction) | <0.1% | –ü—Ä–æ—Å—Ç–∞—è –∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞ |
| Memory | ~1 KB | 10 –∏–∑–º–µ—Ä–µ–Ω–∏–π √ó ~100 –±–∞–π—Ç |
| Network | **~2 req/s** | demo_marktick –∫–∞–∂–¥—ã–µ 0.5s (–±—ã–ª–æ 4 req/s) |
| Latency | <10ms | –õ–æ–∫–∞–ª—å–Ω—ã–π telnet |
| Accuracy (speed) | ¬±5% | –ó–∞–≤–∏—Å–∏—Ç –æ—Ç polling_interval |
| Accuracy (pause) | 100% | –ü–æ—Å–ª–µ 3 –∏–∑–º–µ—Ä–µ–Ω–∏–π |

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

**–£–º–µ–Ω—å—à–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ —Å–µ—Ç—å:**
```python
polling_interval = 0.5  # –í–º–µ—Å—Ç–æ 0.25s (2 req/s –≤–º–µ—Å—Ç–æ 4)
```

**–£–≤–µ–ª–∏—á–∏—Ç—å —Ç–æ—á–Ω–æ—Å—Ç—å:**
```python
polling_interval = 0.1  # –í–º–µ—Å—Ç–æ 0.25s (10 req/s)
history_size = 20       # –ë–æ–ª—å—à–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
```

---

## üéì –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

### –ü–æ—á–µ–º—É demo_marktick, –∞ –Ω–µ demo_pause/resume?

| demo_pause/resume | demo_marktick |
|-------------------|---------------|
| ‚ùå –ü–∞—É–∑–∏—Ç –¥–µ–º–æ (choppy) | ‚úÖ –ü–∞—Å—Å–∏–≤–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ |
| ‚ùå –¢—Ä–µ–±—É–µ—Ç resume –ø–æ—Å–ª–µ pause | ‚úÖ –û–¥–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ |
| ‚ùå –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç playback tick | ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç FILE tick (—Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å demoparser2) |
| ‚ùå –ú–µ–¥–ª–µ–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ (~100ms) | ‚úÖ –ë—ã—Å—Ç—Ä–∞—è –∫–æ–º–∞–Ω–¥–∞ (~10ms) |

### –ü–æ—á–µ–º—É –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏?

–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã:
1. ‚ùå `demo_timescale` –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ - –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ
2. ‚ùå `con_logfile` - –∫–æ–º–∞–Ω–¥–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ CS2
3. ‚ùå Memory reading - VAC-unsafe
4. ‚úÖ **–í—ã—á–∏—Å–ª–µ–Ω–∏–µ –∏–∑ tick history** - –Ω–∞–¥–µ–∂–Ω–æ, VAC-safe, —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞

### –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **Adaptive polling interval**
   - –ü—Ä–∏ –ø–∞—É–∑–µ —É–º–µ–Ω—å—à–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É –æ–ø—Ä–æ—Å–∞
   - –ü—Ä–∏ –±—ã—Å—Ç—Ä–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ —É–≤–µ–ª–∏—á–∏—Ç—å —á–∞—Å—Ç–æ—Ç—É

2. **Speed change events**
   - –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑–∫—É—é —Å–º–µ–Ω—É —Å–∫–æ—Ä–æ—Å—Ç–∏
   - –ë—ã—Å—Ç—Ä–µ–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è–º

3. **Predictive pause detection**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—É—é (dTick/dt)
   - –î–µ—Ç–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—É–∑—É –∑–∞ 1 –∏–∑–º–µ—Ä–µ–Ω–∏–µ –≤–º–µ—Å—Ç–æ 3

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `src/core/smart_tick_sync.py` - –û—Å–Ω–æ–≤–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
- `src/network/telnet_client.py` - Telnet –∫–ª–∏–µ–Ω—Ç —Å demo_marktick
- `src/core/orchestrator.py` - Integration –≤ –æ—Å–Ω–æ–≤–Ω–æ–π loop
- `src/domain/models.py` - InputData —Å playback_speed
- `test_smart_tick_sync.py` - –¢–µ—Å—Ç—ã —Å–∏—Å—Ç–µ–º—ã

---

## üìù Changelog

### v2.1 - Research-Based Improvements (Current)
- üîß **polling_interval —É–≤–µ–ª–∏—á–µ–Ω —Å 0.25s ‚Üí 0.5s** (research recommendation)
  - –ú–µ–Ω—å—à–µ jitter, –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è
  - –°–Ω–∏–∂–µ–Ω–∞ –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ç—å —Å 4 req/s –¥–æ 2 req/s
  - Accuracy –æ—Å—Ç–∞–µ—Ç—Å—è ¬±5%, –Ω–æ —Å –º–µ–Ω—å—à–∏–º–∏ –∫–æ–ª–µ–±–∞–Ω–∏—è–º–∏
- ‚ú® **Tick jump detection** (Shift+F2 goto handling)
  - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∏–∑–º–µ—Ä–µ–Ω–∏—è –ø—Ä–∏ —Å–∫–∞—á–∫–∞—Ö —Ç–∏–∫–æ–≤
  - –ó–∞—â–∏—Ç–∞ –æ—Ç –ª–æ–∂–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å–∫–æ—Ä–æ—Å—Ç–∏
- ‚ú® **Outlier detection** (threshold=0.5x)
  - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∞–Ω–æ–º–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π
  - –ó–∞—â–∏—Ç–∞ –æ—Ç —Å–µ—Ç–µ–≤—ã—Ö –≥–ª—é–∫–æ–≤ –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ª–∞–≥–æ–≤
- üìö –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å edge cases

### v2.0 - Speed-Aware System
- ‚ú® –î–æ–±–∞–≤–ª–µ–Ω SmartTickSync —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Å–∫–æ—Ä–æ—Å—Ç–∏
- ‚ú® –¢–æ—á–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –ø–∞—É–∑—ã vs –º–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å
- ‚ú® Speed-aware tick prediction
- ‚ú® –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ demo_marktick (passive polling)
- ‚ú® –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ playback_speed –≤ InputData
- üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–∂–Ω–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –ø–∞—É–∑—ã –ø—Ä–∏ tick=0

### v1.0 - Basic System
- –ë–∞–∑–æ–≤–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ demo_info
- –ü—Ä–æ—Å—Ç–∞—è –¥–µ—Ç–µ–∫—Ü–∏—è –ø–∞—É–∑—ã
- –õ–∏–Ω–µ–π–Ω–æ–µ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–µ —Ç–∏–∫–æ–≤

---

**–ê–≤—Ç–æ—Ä**: AI Assistant
**–î–∞—Ç–∞**: 2025-01-19
**–í–µ—Ä—Å–∏—è**: 2.1
